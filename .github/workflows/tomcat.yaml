name: ci/cd pipeline to deploy to tomcat

on:
  push:
    branches:
      - master

jobs:
  build-publish-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # Build + test + SonarQube
      - name: Build, Test and SonarQube Scan
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=train-ticket-reservation \
            -Dsonar.host.url="${{ secrets.SONAR_HOST }}" \
            -Dsonar.login="${{ secrets.SONAR_TOKEN }}"

      - name: Verify WAR file
        run: ls -lh target/

      # ---------- Publish to Nexus ----------
      - name: Publish WAR to Nexus
        run: |
          # Example: 1.0.16, 1.0.17, ...
          VERSION="1.0.${{ github.run_number }}"

          mvn org.apache.maven.plugins:maven-deploy-plugin:3.1.2:deploy-file \
            -Durl=${{ secrets.NEXUS_URL }} \
            -DrepositoryId=${{ secrets.NEXUS_REPO_ID }} \
            -DgroupId=TrainBook \
            -DartifactId=TrainBook \
            -Dversion=$VERSION \
            -Dpackaging=war \
            -Dfile=target/TrainBook-1.0.0-SNAPSHOT.war \
            -DgeneratePom=true

      # ---------- Deploy to Tomcat ----------
      - name: Deploy WAR to Tomcat
        run: |
          curl -v -u "${{ secrets.TOMCAT_USER }}:${{ secrets.TOMCAT_PASSWORD }}" \
            -T target/TrainBook-1.0.0-SNAPSHOT.war \
            "http://${{ secrets.TOMCAT_HOST }}:8080/manager/text/deploy?path=/TrainBook&update=true"
